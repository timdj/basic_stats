<?php
/**
 * @file
 * Module file for basic_stats.
 */


/**
 * Get number of publishes nodes per content type
 * @param $content_type
 *
 * @return int
 */
function basic_stats_number_nodes($content_type=NULL) {
  $totals = &drupal_static(__FUNCTION__);
  if (!isset($totals[$content_type])) {
    $query = db_select('node', 'n');
    $query->fields('n', array('nid'));
    $query->condition('status', 1, '=');
    if($content_type) {
      $query->condition('type', $content_type, '=');
    }
    $nodes = $query->execute();

    $totals[$content_type] = $nodes->rowCount();;
  }
  return $totals[$content_type];
}

/**
 * Get number of active users, optional per role
 * @param array $roles
 *
 * @return int
 */
function basic_stats_number_users($roles=array()) {
  $usercount = &drupal_static(__FUNCTION__);
  if(!isset($usercount)) {
    $query = db_select('users', 'u');
    $query->fields('u', array('uid'));
    $query->condition('status', 1, '=');
    $users     = $query->execute();
    $usercount = $users->rowCount();
  }
  return $usercount;
}









/**
 * Implements hook_block_info().
 *
 */
function basic_stats_block_info() {
  $blocks['basic_stats'] = array(
    'info'  => t('Basic stats: Block showing site stats'),
    'cache' => DRUPAL_CACHE_GLOBAL,
  );

  return $blocks;
}

/**
 * Implements hook_block_configure().
 *
 * This hook declares configuration options for blocks provided by this module.
 */
function basic_stats_block_configure($delta = '') {
  $form = array();
  if ($delta == 'basic_stats') {
    $node_types = node_type_get_types();
    $type_options = array();
    foreach($node_types as $content_type) {
      $type_options[$content_type->type] = $content_type->name;
    }

  /*  $form['block_stats']['node_types'] = array(
      '#title' => t('What node totals to show'),
      '#type' => 'checkboxes',
      '#options' => $type_options,
      '#default_value' =>
    );*/



    // All we need to provide is the specific configuration options for our
    // block. Drupal will take care of the standard block configuration options
    // (block title, page visibility, etc.) and the save button.
    $form['block_example_string'] = array(
      '#type'          => 'textfield',
      '#title'         => t('Block contents'),
      '#size'          => 60,
      '#description'   => t('This text will appear in the example block.'),
      '#default_value' => variable_get('block_example_string', t('Some example content.')),
    );
  }
  return $form;
}

/**
 * Implements hook_block_save().
 *
 */
function basic_stats_block_save($delta = '', $edit = array()) {
  // We need to save settings from the configuration form.
  // We need to check $delta to make sure we are saving the right block.
  if ($delta == 'basic_stats') {
    // Have Drupal save the string to the database.
    variable_set('block_example_string', $edit['block_example_string']);
  }
}


/**
 * Implements hook_block_view().
 *
 */
function basic_stats_block_view($delta = '') {
  // The $delta parameter tells us which block is being requested.
  switch ($delta) {
    case 'basic_stats':
      // The subject is displayed at the top of the block. Note that it
      // should be passed through t() for translation. The title configured
      // for the block using Drupal UI supercedes this one.
      $block['subject'] = t('Site statistics');
      // The content of the block is typically generated by calling a custom
      // function.
      $block['content'] = basic_stats_block_contents($delta);
      break;
  }
  return $block;
}

/**
 * Get basic stats block contents
 * @return string
 */
function basic_stats_block_contents() {
  $node_types = node_type_get_types();
  $output = '';
  foreach ($node_types as $content_type) {
    $output .= $content_type->name . ':' . basic_stats_number_nodes($content_type->type);
  }
  $output .= "users" . basic_stats_number_users();
  return $output;
}
